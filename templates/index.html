{% extends 'base.html' %}

{% block head %}<title>Task Smash</title>{% endblock %}

{% block body %}
<div class="page">
  <div class="card">
    <h1 class="title">Task Smash 2.0</h1>
    <p class="subtitle">Search â€¢ Pagination â€¢ CSV Import/Export â€¢ API Ready</p>

    <!-- Search + Per page (GET) -->
    <form method="GET" action="/" class="toolbar">
      <div class="toolbar-left">
        <input class="input" type="text" name="q" placeholder="Search tasks..." value="{{ q }}" />
        <button class="btn btn-primary" type="submit">Search</button>
        <a class="btn btn-ghost" href="/">Clear</a>
      </div>

      <div class="toolbar-right">
        <label class="label" for="per_page">Per page</label>
        <select class="select" name="per_page" id="per_page" onchange="this.form.submit()">
          <option value="5"  {% if per_page == 5 %}selected{% endif %}>5</option>
          <option value="10" {% if per_page == 10 %}selected{% endif %}>10</option>
          <option value="20" {% if per_page == 20 %}selected{% endif %}>20</option>
          <option value="50" {% if per_page == 50 %}selected{% endif %}>50</option>
        </select>
        <input type="hidden" name="page" value="1">
      </div>
    </form>

    <!-- Add task (POST) -->
    <form action="/" method="POST" class="add-row">
      <input class="input" type="text" name="content" id="content" placeholder="Add a new task..." required>
      <input class="btn btn-primary" type="submit" value="Add Task" id="btn_add">
    </form>

    <!-- CSV actions -->
    <div class="csv-row">
      <form action="/import-csv" method="POST" enctype="multipart/form-data" class="csv-form">
        <input class="file" type="file" name="file" accept=".csv" required>
        <button class="btn btn-secondary" type="submit">Import CSV</button>
      </form>

      <a class="btn btn-secondary" href="/export-csv">Export CSV</a>
    </div>

    {% if request.args.get('imported') %}
      <div class="alert">
        Imported: <b>{{ request.args.get('imported') }}</b> â€¢
        Skipped: <b>{{ request.args.get('skipped') }}</b> â€¢
        Errors: <b>{{ request.args.get('errors') }}</b>
      </div>
    {% endif %}

    <!-- Tasks -->
    {% if not tasks %}
      <div class="empty">No tasks yet â€” add one above ðŸ‘†</div>
    {% else %}
      <div class="list">
        {% for task in tasks %}
          <div class="todo">
            <div class="todo-main">
              <div class="todo-text">{{ task.content }}</div>
              <div class="todo-meta">
                Created on: {{ task.created.strftime("%d %b %Y") }}
              </div>
            </div>

            <div class="todo-actions">
              <a class="btn btn-danger" href="/delete/{{ task.id }}">Delete</a>
              <a class="btn btn-ghost" href="/update/{{ task.id }}">Edit</a>
            </div>
          </div>
        {% endfor %}
      </div>

      <!-- Pagination -->
      <div class="pager">
        {% if pagination.has_prev %}
          <a class="btn btn-ghost" href="/?page={{ pagination.prev_num }}&per_page={{ per_page }}&q={{ q|urlencode }}">â¬… Prev</a>
        {% else %}
          <span></span>
        {% endif %}

        <div class="pager-mid">
          Page <b>{{ pagination.page }}</b> of <b>{{ pagination.pages }}</b>
          {% if q %}<span class="pill">filtered</span>{% endif %}
        </div>

        {% if pagination.has_next %}
          <a class="btn btn-ghost" href="/?page={{ pagination.next_num }}&per_page={{ per_page }}&q={{ q|urlencode }}">Next âž¡</a>
        {% else %}
          <span></span>
        {% endif %}
      </div>
    {% endif %}
  </div>
</div>
{% endblock %}
