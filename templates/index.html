{% extends 'base.html' %}

{% block head %}<title>Task Smash</title>{% endblock %}

{% block body %}
<div class="page">
  <div class="card">
    <div style="display:flex; justify-content:space-between; align-items:center; gap:12px;">
      <div>
        <h1 class="title">Task Smash 2.0</h1>
        <p class="subtitle">Search ‚Ä¢ Pagination ‚Ä¢ CSV Import/Export ‚Ä¢ API Ready</p>
      </div>

      <!-- Back to dashboard -->
      <a class="btn btn-ghost" href="/dashboard">‚Üê Projects</a>
    </div>

    <!-- Search + Per page + Sort (GET) -->
    <form method="GET" action="/projects/{{ project_id }}" class="toolbar">
      <div class="toolbar-left">
        <input
          class="input"
          type="text"
          name="q"
          placeholder="Search tasks..."
          value="{{ q }}"
        />
        <button class="btn btn-primary" type="submit">Search</button>
        <a class="btn btn-ghost" href="/projects/{{ project_id }}">Clear</a>
      </div>

      <div class="toolbar-right">
        <label class="label" for="per_page">Per page</label>
        <select class="select" name="per_page" id="per_page" onchange="this.form.submit()">
          <option value="5"  {% if per_page == 5 %}selected{% endif %}>5</option>
          <option value="10" {% if per_page == 10 %}selected{% endif %}>10</option>
          <option value="20" {% if per_page == 20 %}selected{% endif %}>20</option>
          <option value="50" {% if per_page == 50 %}selected{% endif %}>50</option>
        </select>

        <label class="label" for="sort">Sort</label>
        <select class="select" name="sort" id="sort" onchange="this.form.submit()">
          <option value="desc" {% if sort != 'asc' %}selected{% endif %}>Newest first</option>
          <option value="asc" {% if sort == 'asc' %}selected{% endif %}>First added</option>
        </select>

        <!-- Always reset page back to 1 when changing filters -->
        <input type="hidden" name="page" value="1" />
      </div>
    </form>

    <!-- Add task (POST) -->
    <form action="/projects/{{ project_id }}" method="POST" class="add-row">
      <input class="input" type="text" name="content" id="content" placeholder="Add a new task..." required>
      <button class="btn btn-primary" type="submit">Add Task</button>
    </form>

    <!-- CSV actions -->
    <div class="csv-row">
      <!-- Import CSV (POST) -->
      <form
        action="/projects/{{ project_id }}/import-csv"
        method="POST"
        enctype="multipart/form-data"
        class="csv-form"
      >
        <input class="file" type="file" name="file" accept=".csv" required>
        <button class="btn btn-secondary" type="submit">Import CSV</button>
      </form>

      <!-- Export CSV (GET) -->
      <a
        class="btn btn-secondary"
        href="/projects/{{ project_id }}/export-csv?q={{ q|urlencode }}"
      >
        Export CSV
      </a>
    </div>

    {% if request.args.get('imported') %}
      <div class="alert">
        Imported: <b>{{ request.args.get('imported') }}</b> ‚Ä¢
        Skipped: <b>{{ request.args.get('skipped') }}</b> ‚Ä¢
        Errors: <b>{{ request.args.get('errors') }}</b>
      </div>
    {% endif %}

    <!-- Tasks -->
    {% if not tasks %}
      <div class="empty">No tasks yet ‚Äî add one above üëÜ</div>
    {% else %}
      <div class="list">
        {% for task in tasks %}
          <div class="todo">
            <div class="todo-main">
              <div class="todo-text">{{ task.content }}</div>
              <div class="todo-meta">
                Created on: {{ task.created.strftime("%d %b %Y") }}
              </div>
            </div>

            <div class="todo-actions">
              <!-- These routes must exist in backend -->
              <a class="btn btn-danger" href="/projects/{{ project_id }}/delete/{{ task.id }}">Delete</a>
              <a class="btn btn-ghost" href="/projects/{{ project_id }}/update/{{ task.id }}">Edit</a>
            </div>
          </div>
        {% endfor %}
      </div>

      <!-- Pagination -->
      <div class="pager">
        {% if pagination.has_prev %}
          <a
            class="btn btn-ghost"
            href="/projects/{{ project_id }}?page={{ pagination.prev_num }}&per_page={{ per_page }}&q={{ q|urlencode }}&sort={{ sort }}"
          >
            ‚¨Ö Prev
          </a>
        {% else %}
          <span></span>
        {% endif %}

        <div class="pager-mid">
          Page <b>{{ pagination.page }}</b> of <b>{{ pagination.pages }}</b>
          {% if q %}<span class="pill">filtered</span>{% endif %}
        </div>

        {% if pagination.has_next %}
          <a
            class="btn btn-ghost"
            href="/projects/{{ project_id }}?page={{ pagination.next_num }}&per_page={{ per_page }}&q={{ q|urlencode }}&sort={{ sort }}"
          >
            Next ‚û°
          </a>
        {% else %}
          <span></span>
        {% endif %}
      </div>
    {% endif %}
  </div>
</div>
{% endblock %}
